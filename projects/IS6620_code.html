<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #ffffff; }
body .c { color: #888 } /* Comment */
body .err { color: #F00; background-color: #FAA } /* Error */
body .k { color: #080; font-weight: bold } /* Keyword */
body .o { color: #333 } /* Operator */
body .ch { color: #888 } /* Comment.Hashbang */
body .cm { color: #888 } /* Comment.Multiline */
body .cp { color: #579 } /* Comment.Preproc */
body .cpf { color: #888 } /* Comment.PreprocFile */
body .c1 { color: #888 } /* Comment.Single */
body .cs { color: #C00; font-weight: bold } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #F00 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888 } /* Generic.Output */
body .gp { color: #C65D09; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #04D } /* Generic.Traceback */
body .kc { color: #080; font-weight: bold } /* Keyword.Constant */
body .kd { color: #080; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #080; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #038; font-weight: bold } /* Keyword.Pseudo */
body .kr { color: #080; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #339; font-weight: bold } /* Keyword.Type */
body .m { color: #60E; font-weight: bold } /* Literal.Number */
body .s { background-color: #FFF0F0 } /* Literal.String */
body .na { color: #00C } /* Name.Attribute */
body .nb { color: #007020 } /* Name.Builtin */
body .nc { color: #B06; font-weight: bold } /* Name.Class */
body .no { color: #036; font-weight: bold } /* Name.Constant */
body .nd { color: #555; font-weight: bold } /* Name.Decorator */
body .ni { color: #800; font-weight: bold } /* Name.Entity */
body .ne { color: #F00; font-weight: bold } /* Name.Exception */
body .nf { color: #06B; font-weight: bold } /* Name.Function */
body .nl { color: #970; font-weight: bold } /* Name.Label */
body .nn { color: #0E84B5; font-weight: bold } /* Name.Namespace */
body .nt { color: #070 } /* Name.Tag */
body .nv { color: #963 } /* Name.Variable */
body .ow { color: #000; font-weight: bold } /* Operator.Word */
body .w { color: #BBB } /* Text.Whitespace */
body .mb { color: #60E; font-weight: bold } /* Literal.Number.Bin */
body .mf { color: #60E; font-weight: bold } /* Literal.Number.Float */
body .mh { color: #058; font-weight: bold } /* Literal.Number.Hex */
body .mi { color: #00D; font-weight: bold } /* Literal.Number.Integer */
body .mo { color: #40E; font-weight: bold } /* Literal.Number.Oct */
body .sa { background-color: #FFF0F0 } /* Literal.String.Affix */
body .sb { background-color: #FFF0F0 } /* Literal.String.Backtick */
body .sc { color: #04D } /* Literal.String.Char */
body .dl { background-color: #FFF0F0 } /* Literal.String.Delimiter */
body .sd { color: #D42 } /* Literal.String.Doc */
body .s2 { background-color: #FFF0F0 } /* Literal.String.Double */
body .se { color: #666; font-weight: bold; background-color: #FFF0F0 } /* Literal.String.Escape */
body .sh { background-color: #FFF0F0 } /* Literal.String.Heredoc */
body .si { background-color: #EEE } /* Literal.String.Interpol */
body .sx { color: #D20; background-color: #FFF0F0 } /* Literal.String.Other */
body .sr { color: #000; background-color: #FFF0FF } /* Literal.String.Regex */
body .s1 { background-color: #FFF0F0 } /* Literal.String.Single */
body .ss { color: #A60 } /* Literal.String.Symbol */
body .bp { color: #007020 } /* Name.Builtin.Pseudo */
body .fm { color: #06B; font-weight: bold } /* Name.Function.Magic */
body .vc { color: #369 } /* Name.Variable.Class */
body .vg { color: #D70; font-weight: bold } /* Name.Variable.Global */
body .vi { color: #33B } /* Name.Variable.Instance */
body .vm { color: #963 } /* Name.Variable.Magic */
body .il { color: #00D; font-weight: bold } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="c1"># pip install numpy sentence-transformers langchain transformers peft torch fuzzywuzzy python-Levenshtein googlesearch-python beautifulsoup4 requests streamlit</span>

<span class="c1"># ===========================</span>
<span class="c1"># Step 1: Import necessary libraries</span>
<span class="c1"># ===========================</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sentence_transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span><span class="p">,</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModelForCausalLM</span><span class="p">,</span> <span class="n">TextIteratorStreamer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">peft</span><span class="w"> </span><span class="kn">import</span> <span class="n">PeftModel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fuzzywuzzy</span><span class="w"> </span><span class="kn">import</span> <span class="n">process</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">googlesearch</span><span class="w"> </span><span class="kn">import</span> <span class="n">search</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bs4</span><span class="w"> </span><span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">pipeline</span>

<span class="c1"># ===========================</span>
<span class="c1"># Step 2: Define file paths</span>
<span class="c1"># ===========================</span>

<span class="n">book_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\6620_combined\HP1.txt&quot;</span> 
<span class="n">processed_text_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\6620_combined\processed_text.txt&quot;</span> <span class="c1">#&quot;your_path\processed_text.txt&quot;</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\6620_combined&quot;</span>  

<span class="c1"># ===========================</span>
<span class="c1"># Step 3: Define the BookProcessor class</span>
<span class="c1"># This class handles loading, preprocessing, chunking, and embedding of the book text.</span>
<span class="c1"># Here we only access Harry Potter and the Sorcerer&#39;s Stone (HP1).</span>
<span class="c1"># As all the Harry Potter books text file are different, making it difficult to clean and process them all at once.</span>
<span class="c1"># ===========================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BookProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">book_path</span><span class="p">,</span> <span class="n">processed_text_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the BookProcessor with paths and model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book_path</span> <span class="o">=</span> <span class="n">book_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed_text_path</span> <span class="o">=</span> <span class="n">processed_text_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="s1">&#39;all-MiniLM-L6-v2&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">preprocess_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess the text by performing basic cleaning operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocessing text...&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> 
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>  
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_and_preprocess_book</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load book content, preprocess it, and save the processed text.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading and preprocessing the book...&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        
        <span class="c1"># Call the preprocess_text method</span>
        <span class="n">processed_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        
        <span class="c1"># Save the processed text to a .txt file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processed_text_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">processed_text</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed text saved to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">processed_text_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">processed_text</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">chunk_and_embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use RecursiveCharacterTextSplitter to split the text into chunks and generate embeddings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Chunking and generating embeddings...&quot;</span><span class="p">)</span>
        <span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span>
            <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>       <span class="c1"># Maximum number of characters per chunk</span>
            <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>     <span class="c1"># Number of overlapping characters between chunks</span>
            <span class="n">separators</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">],</span>  <span class="c1"># List of separators in order of priority</span>
        <span class="p">)</span>
        
        <span class="n">chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># Split the text</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>  <span class="c1"># Generate embeddings</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;chunks&quot;</span><span class="p">:</span> <span class="n">chunks</span><span class="p">,</span>
            <span class="s2">&quot;embeddings&quot;</span><span class="p">:</span> <span class="n">embeddings</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_intermediate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save chunks and embeddings to the specified directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving intermediate results...&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;chunks.json&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;chunks&#39;</span><span class="p">],</span> <span class="n">file</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;embeddings.npy&#39;</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;embeddings&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intermediate results saved to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main process to load, preprocess, chunk, embed, and save results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Step 1: Load and preprocess the book</span>
        <span class="n">processed_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_and_preprocess_book</span><span class="p">()</span>
        
        <span class="c1"># Step 2: Chunk and generate embeddings</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_and_embed</span><span class="p">(</span><span class="n">processed_text</span><span class="p">)</span>
        
        <span class="c1"># Step 3: Save intermediate results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_intermediate_results</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing completed successfully!&quot;</span><span class="p">)</span>

<span class="c1"># ===========================</span>
<span class="c1"># Step 4: Define the TextClassifier class</span>
<span class="c1"># This class handles loading the fine-tuned text classification model and classifying input text.</span>
<span class="c1"># We used a set of questions and coresponding labels to fine-tune the model.</span>
<span class="c1"># ===========================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TextClassifier</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_classification_model</span><span class="p">,</span> <span class="n">finetune_path</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="n">base_model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="n">text_classification_model</span><span class="p">,</span>
            <span class="n">num_labels</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span>
            <span class="n">torch_dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># Load LoRA weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PeftModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">finetune_path</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># Merge LoRA weights to optimize inference speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">merge_and_unload</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">text_classification_model</span><span class="p">)</span>       
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">classify_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
       
        <span class="c1"># Perform inference</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">max_index</span><span class="p">],</span> <span class="n">scores</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">classify_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">category</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;character&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;plot&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">3</span>

<span class="c1"># ===========================</span>
<span class="c1"># Step 5: Define the QueryProcessor class</span>
<span class="c1"># If the query is related to the plot, it will call this class.</span>
<span class="c1"># This class handles loading the intermediate results (chunks and embeddings),</span>
<span class="c1"># generating the query embedding, finding the most similar chunks based on Euclidean distance,</span>
<span class="c1"># and return the top-k most relevant chunks.</span>
<span class="c1"># ===========================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">QueryProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">query_embedding_model</span><span class="o">=</span><span class="s1">&#39;all-MiniLM-L6-v2&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the QueryProcessor with paths and model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="n">query_embedding_model</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_intermediate_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load chunks and embeddings from the specified directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading intermediate results...&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;chunks.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        
        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;embeddings.npy&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">embeddings</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_query_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an embedding for the given query using the provided model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating query embedding...&quot;</span><span class="p">)</span>
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query_embedding</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_most_similar_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_embedding</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the most similar chunks to the query based on Euclidean distance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding most similar chunks...&quot;</span><span class="p">)</span>
        <span class="c1"># Calculate Euclidean distances between query and all embeddings</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">embeddings</span> <span class="o">-</span> <span class="n">query_embedding</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Get indices of top-k most similar chunks (smallest distances)</span>
        <span class="n">top_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">distances</span><span class="p">)[:</span><span class="n">top_k</span><span class="p">]</span>
        
        <span class="c1"># Retrieve the corresponding chunks and their distance scores</span>
        <span class="n">top_chunks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_indices</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">top_chunks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a query to find the most relevant chunks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Step 1: Load intermediate results</span>
        <span class="n">chunks</span><span class="p">,</span> <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_intermediate_results</span><span class="p">()</span>
        
        <span class="c1"># Step 2: Generate query embedding</span>
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_query_embedding</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        
        <span class="c1"># Step 3: Find most similar chunks</span>
        <span class="n">top_chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_most_similar_chunks</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">top_chunks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_topk_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the top-k most relevant chunks as a single concatenated string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Process the query to get the top-k chunks</span>
        <span class="n">top_chunks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>
        
        <span class="c1"># Extract only the text of the chunks</span>
        <span class="n">top_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">chunk</span> <span class="k">for</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">top_chunks</span><span class="p">]</span>
        
        <span class="c1"># Concatenate the texts into a single string</span>
        <span class="n">concatenated_text</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">top_texts</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">concatenated_text</span>

<span class="c1"># ===========================</span>
<span class="c1"># Step 6: Define the HPCharacterInfo class</span>
<span class="c1"># If the query is related to a character, it will call this class.</span>
<span class="c1"># This class handles fetching character data from the API.</span>
<span class="c1"># It uses fuzzy matching to identify character names from the question.</span>
<span class="c1"># If the character name is found, it retrieves detailed information about that character.</span>
<span class="c1"># ===========================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HPCharacterInfo</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_url</span><span class="o">=</span><span class="s2">&quot;https://hp-api.onrender.com/api/characters&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_url</span> <span class="o">=</span> <span class="n">api_url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_characters_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch character data from the API.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>  <span class="c1"># Return JSON data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Failed to fetch character data. Please check if the API is available.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_character_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">characters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract character name from the question using fuzzy matching.&quot;&quot;&quot;</span>
        <span class="c1"># Extract all character names</span>
        <span class="n">character_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">character</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">characters</span> <span class="k">if</span> <span class="n">character</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)]</span>
        
        <span class="c1"># Use fuzzywuzzy&#39;s process.extractOne to find the best match</span>
        <span class="n">match</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">extractOne</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">character_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>  <span class="c1"># Set a threshold to avoid mismatches</span>
            <span class="k">return</span> <span class="n">match</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_character_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">character_name</span><span class="p">,</span> <span class="n">characters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get detailed information about a character.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">character</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">character_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">character</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">answer_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Answer the question by fetching and processing character data.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Call API to fetch character data</span>
            <span class="n">characters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_characters_data</span><span class="p">()</span>
            
            <span class="c1"># Extract character name</span>
            <span class="n">character_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_character_name</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">characters</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">character_name</span><span class="p">:</span>
                <span class="c1"># Get detailed character information</span>
                <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_character_info</span><span class="p">(</span><span class="n">character_name</span><span class="p">,</span> <span class="n">characters</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                    <span class="c1"># Format the output</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Information about </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Ignore fields with null values</span>
                            <span class="n">response</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">return</span> <span class="n">response</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Details about </span><span class="si">{</span><span class="n">character_name</span><span class="si">}</span><span class="s2"> were not found.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Sorry, I couldn&#39;t identify the character name in the question.&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># ===========================</span>
<span class="c1"># Step 7: Define the WebSearcher class</span>
<span class="c1"># If the query is not related to character or plot, it will call this class.</span>
<span class="c1"># This class handles performing a web search using the Google search API,</span>
<span class="c1"># fetching the webpage content, and cleaning it for LLM input.</span>
<span class="c1"># ===========================</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WebSearcher</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_results</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the WebSearcher with a query and number of results to fetch.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            query (str): The search query.</span>
<span class="sd">            num_results (int): Number of search results to process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_results</span> <span class="o">=</span> <span class="n">num_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">perform_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a web search and store the results as a list of dictionaries.</span>
<span class="sd">        Each dictionary contains the URL and cleaned content of a webpage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Perform the search and iterate over the top results</span>
            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">num_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_results</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Fetch the webpage content</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Extract text content and clean it</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Use newline as separator for readability</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>  <span class="c1"># Remove extra whitespace</span>
                    
                    <span class="k">if</span> <span class="n">body</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>  <span class="c1"># Only add if the content is not empty</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
                            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">body</span><span class="p">[:</span><span class="mi">1000</span><span class="p">]</span>  <span class="c1"># Limit content to the first 1000 characters</span>
                        <span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing webpage </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during web search: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_llm_input</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine all content from the search results into a single string for LLM input.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: A single string containing all content from the search results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># ===========================</span>
<span class="c1"># Step 8: Define the main query processing function</span>
<span class="c1"># This function processes the input query, classifies it, and returns the appropriate information.</span>
<span class="c1"># It uses the TextClassifier to determine the type of query (character, plot, or other),</span>
<span class="c1"># and then calls the appropriate class (HPCharacterInfo or QueryProcessor or WebSearcher)</span>
<span class="c1"># to handle the query accordingly.</span>
<span class="c1"># ===========================</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_query_and_get_info</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the input query, classify it, and return the appropriate information.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        query (str): The input query.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: The response based on the query type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step 1: Initialize the TextClassifier with required parameters</span>
    <span class="n">text_classifier</span> <span class="o">=</span> <span class="n">TextClassifier</span><span class="p">(</span>
        <span class="n">text_classification_model</span><span class="o">=</span> <span class="s2">&quot;BAAI/bge-reranker-v2-gemma&quot;</span><span class="p">,</span>  <span class="c1"># Replace with your model</span>
        <span class="n">finetune_path</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;D:\6620_combined\checkpoint-378&quot;</span><span class="p">,</span>   <span class="c1"># Replace with your fine-tuned model path</span>
        <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;character&quot;</span><span class="p">,</span> <span class="s2">&quot;plot&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">]</span>          <span class="c1"># Define the labels</span>
    <span class="p">)</span>
    
    <span class="c1"># Step 2: Classify the query</span>
    <span class="n">query_type_id</span> <span class="o">=</span> <span class="n">text_classifier</span><span class="o">.</span><span class="n">classify_question</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    
    <span class="c1"># Step 3: Handle the query based on its type</span>
    <span class="k">if</span> <span class="n">query_type_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Character-related question</span>
        <span class="n">hp_character_info</span> <span class="o">=</span> <span class="n">HPCharacterInfo</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">hp_character_info</span><span class="o">.</span><span class="n">answer_question</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">query_type_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Plot-related question</span>
        <span class="n">query_processor</span> <span class="o">=</span> <span class="n">QueryProcessor</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;D:\6620_hp\intermediate_HP1&quot;</span><span class="p">)</span>  <span class="c1"># Replace with your output directory</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">query_processor</span><span class="o">.</span><span class="n">get_topk_text</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Other types of questions</span>
        <span class="n">web_searcher</span> <span class="o">=</span> <span class="n">WebSearcher</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">num_results</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">web_searcher</span><span class="o">.</span><span class="n">perform_search</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">web_searcher</span><span class="o">.</span><span class="n">get_llm_input</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">query_type_id</span><span class="p">,</span> <span class="n">response</span>

<span class="c1"># ===========================</span>
<span class="c1"># Step 9: Streamlit app setup</span>
<span class="c1"># This part initializes the Streamlit app and processes the book once to prepare it for queries.</span>
<span class="c1"># This is only run once to preprocess the book text and generate embeddings.</span>
<span class="c1"># It ensures that the book is processed before any queries are made.</span>
<span class="c1"># ===========================</span>

<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_book_once</span><span class="p">():</span>
    <span class="n">book_processor</span> <span class="o">=</span> <span class="n">BookProcessor</span><span class="p">(</span><span class="n">book_path</span><span class="p">,</span> <span class="n">processed_text_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>
    <span class="n">book_processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
<span class="n">process_book_once</span><span class="p">()</span>

<span class="c1"># ===========================</span>
<span class="c1"># Step 10: Streamlit UI logic</span>
<span class="c1"># This is the main part of the Streamlit app where user input is handled,</span>
<span class="c1"># messages are displayed, and responses are generated.</span>
<span class="c1"># It maintains the last few messages in the session state to keep the conversation context alive.</span>
<span class="c1"># and updates the UI with user queries and assistant responses.</span>
<span class="c1"># ===========================</span>

<span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Harry Potter Wizard Land&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="s2">&quot;messages&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a wizard of Harry Potter and a helpful but naughty assistant.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
    <span class="p">]</span>

<span class="n">model_id</span> <span class="o">=</span> <span class="s2">&quot;meta-llama/Llama-3.2-3B-Instruct&quot;</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span>
    <span class="s2">&quot;text-generation&quot;</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
    <span class="n">torch_dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span>
    <span class="n">device_map</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">chat_message</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">chat_message</span><span class="p">(</span><span class="s2">&quot;assistant&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assistant: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">user_input</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">chat_input</span><span class="p">(</span><span class="s2">&quot;Ah, curious soul, what secrets do ye wish to uncover?&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">user_input</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="p">})</span>
    <span class="n">st</span><span class="o">.</span><span class="n">chat_message</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You: </span><span class="si">{</span><span class="n">user_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">query_type_id</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">process_query_and_get_info</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>
    
    <span class="n">category_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Character-related&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;Plot-related&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">}</span>
    <span class="n">category_name</span> <span class="o">=</span> <span class="n">category_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_type_id</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**Query classified as:** </span><span class="si">{</span><span class="n">category_name</span><span class="si">}</span><span class="s2"> (Category ID: </span><span class="si">{</span><span class="n">query_type_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">info</span><span class="p">})</span>

    <span class="n">recent_messages</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span>
        <span class="n">recent_messages</span><span class="p">,</span>
        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

    <span class="n">anwser</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;generated_text&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">anwser</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c1"># remove the last system message info</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">anwser</span><span class="p">})</span>
    <span class="n">st</span><span class="o">.</span><span class="n">chat_message</span><span class="p">(</span><span class="s2">&quot;assistant&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assistant: </span><span class="si">{</span><span class="n">anwser</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</body>
</html>
